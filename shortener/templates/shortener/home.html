{% extends "shortener/base.html" %}

{% block content %}
<div class="columns">
    <div class="column is-half">
        <h2 class="title is-4">Shorten a URL</h2>
        <form method="post">
            {% csrf_token %}
            <div class="field">
                <label class="label">{{ form.target_url.label }}</label>
                <div class="control">
                    {{ form.target_url }}
                </div>
                {% if form.target_url.errors %}
                    <p class="help is-danger">{{ form.target_url.errors.0 }}</p>
                {% endif %}
            </div>

            <div class="field">
                <label class="label">{{ form.custom_slug.label }}</label>
                <div class="control">
                    {{ form.custom_slug }}
                </div>
                <p id="slug-help" class="help"></p>
                {% if form.custom_slug.errors %}
                    <p class="help is-danger">{{ form.custom_slug.errors.0 }}</p>
                {% endif %}
            </div>

            <div class="field">
                <div class="control">
                    <button class="button is-primary" type="submit">
                        Shorten
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const slugInput = document.getElementById('id_custom_slug');
    const help = document.getElementById('slug-help');

    if (slugInput && help) {
        let timeoutId = null;

        slugInput.addEventListener('input', function () {
            const value = slugInput.value.trim();
            if (!value) {
                help.textContent = '';
                help.className = 'help';
                return;
            }

            if (timeoutId) {
                clearTimeout(timeoutId);
            }

            timeoutId = setTimeout(() => {
                fetch(`{% url 'shortener:check_slug' %}?slug=${encodeURIComponent(value)}`)
                    .then(resp => resp.json())
                    .then(data => {
                        help.textContent = data.message || '';
                        help.className = 'help';
                        if (data.valid && data.available) {
                            help.classList.add('is-success');
                        } else if (data.valid && !data.available) {
                            help.classList.add('is-danger');
                        }
                    })
                    .catch(() => {
                        help.textContent = '';
                        help.className = 'help';
                    });
            }, 400);
        });
    }
</script>
{% endblock %}
