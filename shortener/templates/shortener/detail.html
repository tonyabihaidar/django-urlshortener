{% extends "shortener/base.html" %}

{% block content %}
<h2 class="title is-4">Link details</h2>

<div class="box">
    <p class="mb-2"><strong>Short URL:</strong></p>

    <div class="field has-addons">
        <div class="control is-expanded">
            <input
                id="short-url-input"
                class="input"
                type="text"
                value="{{ short_url }}"
                readonly
            >
        </div>
        <div class="control">
            <button type="button" class="button is-link" onclick="copyShortUrl()">
                Copy
            </button>
        </div>
    </div>
    <p class="help is-success" id="copy-feedback" style="display:none;">
        Copied to clipboard!
    </p>

    <p class="mt-4">
        <strong>Original URL:</strong>
        <a href="{{ short.target_url }}" target="_blank">{{ short.target_url }}</a>
    </p>

    <p class="mt-1">
        <strong>Created at:</strong> {{ short.created_at }}
    </p>
</div>

<h3 class="title is-5">QR Code</h3>
<div class="box" style="max-width: 220px;">
    <figure class="image">
        <img id="qr-img"
             src="{{ qr_url }}"
             data-slug="{{ short.slug }}"
             alt="QR code for {{ short_url }}">
    </figure>
</div>

<div class="field is-grouped">
    <div class="control">
        <button type="button" class="button is-info" onclick="downloadQrCode()">
            Download QR
        </button>
    </div>
    <div class="control">
        <button type="button" class="button is-link" onclick="shareQrCode()">
            Share QR code
        </button>
    </div>
    <div class="control">
        <a class="button is-light" href="{% url 'shortener:home' %}">Back</a>
    </div>
</div>

<script>
    function copyShortUrl() {
        const input = document.getElementById('short-url-input');
        const feedback = document.getElementById('copy-feedback');
        if (!input) return;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(input.value)
                .then(() => {
                    if (feedback) {
                        feedback.style.display = 'block';
                        feedback.textContent = 'Copied to clipboard!';
                        setTimeout(() => {
                            feedback.style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(() => {
                    alert('Copy failed. Please copy it manually.');
                });
        } else {
            input.select();
            document.execCommand('copy');
            if (feedback) {
                feedback.style.display = 'block';
                feedback.textContent = 'Copied to clipboard!';
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 2000);
            }
        }
    }

    function downloadQrCode() {
        const qrImg = document.getElementById('qr-img');
        if (!qrImg) return;
        const link = document.createElement('a');
        link.href = qrImg.src;
        const slug = qrImg.dataset.slug || 'qr';
        link.download = `qr_${slug}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function shareQrCode() {
        const qrImg = document.getElementById('qr-img');
        if (!qrImg) return;
        const qrUrl = qrImg.src;

        if (navigator.share) {
            navigator.share({
                title: 'QR code for my short URL',
                text: 'Here is the QR code for my short link.',
                url: qrUrl
            }).catch(() => {});
        } else {
            window.open(qrUrl, '_blank');
        }
    }
</script>
{% endblock %}
